// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  password     String
  name         String
  role         String        @default("STAFF") // ADMIN or STAFF
  leads        Lead[]        @relation("AssignedLeads")
  attendances  Attendance[]
  leaveRequests LeaveRequest[]
  tasks        Task[]
  taskNotes    TaskNote[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Lead {
  id            String          @id @default(cuid())
  name          String
  companyName   String?
  email         String?
  phone         String?
  address       String?
  city          String?
  country       String?
  website       String?
  leadValue     Float?
  description   String?
  status        String          @default("PENDING")
  sourceId      String?
  source        LeadSource?     @relation(fields: [sourceId], references: [id])
  assignedToId  String
  assignedTo    User            @relation("AssignedLeads", fields: [assignedToId], references: [id])
  tags          TagOnLead[]
  statusHistory StatusHistory[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model LeadSource {
  id        String   @id @default(cuid())
  name      String   @unique
  leads     Lead[]
  createdAt DateTime @default(now())
}

model Tag {
  id        String      @id @default(cuid())
  name      String      @unique
  color     String      @default("#3b82f6")
  leads     TagOnLead[]
  createdAt DateTime    @default(now())
}

model TagOnLead {
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tagId  String
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([leadId, tagId])
}

model StatusHistory {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  oldStatus String
  newStatus String
  changedBy String
  changedAt DateTime @default(now())
}

// ===== ATTENDANCE SYSTEM =====

model Attendance {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime // The date of attendance
  checkIn     DateTime? // Check-in time
  checkOut    DateTime? // Check-out time
  status      String   @default("PENDING") // PENDING, PRESENT, HALF_DAY, ABSENT, ON_LEAVE
  approvalStatus String @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy  String?  // Admin who approved/rejected
  approvedAt  DateTime?
  note        String?  // Any note from staff or admin
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, date])
}

model LeaveRequest {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime
  leaveType   String   // FULL_DAY, HALF_DAY
  reason      String?
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy  String?
  approvedAt  DateTime?
  adminNote   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ===== TASK MANAGEMENT =====

model Task {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  date        DateTime   // Date of the task
  hoursWorked Float      // Hours spent on task
  status      String     @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED
  notes       TaskNote[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model TaskNote {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String   // Who wrote the note
  user      User     @relation(fields: [userId], references: [id])
  content   String
  createdAt DateTime @default(now())
}

// ===== SYSTEM SETTINGS =====

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}
